<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GazDispo - Administration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #00A651; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.3rem; }
        .btn-back { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; }
        .main { padding: 1.5rem; max-width: 900px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card h2 { margin-bottom: 1rem; color: #2C3E50; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
        input, select { width: 100%; padding: 0.8rem; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 1rem; margin-bottom: 0.8rem; }
        input:focus, select:focus { outline: none; border-color: #00A651; }
        .coords { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .coords input { margin-bottom: 0; }
        .btn-add { background: #00A651; color: white; border: none; padding: 1rem; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 0.5rem; }
        .btn-add:hover { background: #008C45; }
        .hint { background: #E8F5E9; padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; color: #2C3E50; margin-bottom: 0.8rem; border-left: 4px solid #00A651; }
        .brands-section { background: #F8F9FA; border-radius: 10px; padding: 1rem; margin-bottom: 0.8rem; }
        .brands-section h3 { font-size: 1rem; color: #2C3E50; margin-bottom: 0.8rem; }
        .brand-group { background: white; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem; border-left: 3px solid #00A651; }
        .brand-name { font-weight: bold; color: #2C3E50; margin-bottom: 0.5rem; display: flex; align-items: center; }
        .brand-name input[type="checkbox"] { margin-right: 0.5rem; width: auto; }
        .formats { display: flex; gap: 1rem; flex-wrap: wrap; margin-left: 1.5rem; }
        .format-option { display: flex; align-items: center; gap: 0.3rem; }
        .format-option input[type="checkbox"] { width: auto; margin: 0; }
        .station { background: #FAFAFA; border-radius: 10px; padding: 1rem; margin-bottom: 0.8rem; border-left: 4px solid #00A651; }
        .station-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 0.3rem; }
        .station-address { color: #7F8C8D; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .station-phone { color: #00A651; font-size: 0.9rem; margin-bottom: 0.8rem; }
        .station-brands { margin: 0.8rem 0; font-size: 0.85rem; }
        .brand-badge { display: inline-block; background: #E8F5E9; color: #00A651; padding: 0.2rem 0.6rem; border-radius: 12px; margin: 0.2rem; font-size: 0.8rem; }
        .station-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.8rem; }
        .btn-edit { padding: 0.5rem 0.8rem; border-radius: 6px; border: none; background: #3498DB; color: white; font-size: 0.85rem; cursor: pointer; }
        .btn-delete { padding: 0.5rem 0.8rem; border-radius: 6px; border: none; background: #FF6B6B; color: white; font-size: 0.85rem; cursor: pointer; }
        .login-box { max-width: 400px; margin: 3rem auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .login-box h2 { margin-bottom: 1.5rem; }
        .btn-login { background: #00A651; color: white; border: none; padding: 1rem; border-radius: 8px; font-size: 1rem; cursor: pointer; width: 100%; }
        .hidden { display: none !important; }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #00A651; color: white; padding: 1rem 2rem; border-radius: 8px; font-weight: bold; z-index: 9999; }
        #status { padding: 1rem; text-align: center; color: #7F8C8D; font-style: italic; }
        .edit-mode { border-left: 4px solid #3498DB !important; background: #EBF5FB !important; }
    </style>
</head>
<body>

<header class="header">
    <h1>‚öôÔ∏è Administration GazDispo</h1>
    <a href="index.html" class="btn-back">‚Üê Retour</a>
</header>

<div id="loginBox" class="main">
    <div class="login-box">
        <h2>üîê Connexion Admin</h2>
        <input type="password" id="passwordInput" placeholder="Mot de passe">
        <button class="btn-login" onclick="login()">Se connecter</button>
        <p style="margin-top:1rem;color:#999;font-size:0.9rem;">Contactez l'administrateur pour le mot de passe</p>
    </div>
</div>

<div id="adminBox" class="main hidden">
    <div id="status">Connexion Firebase...</div>

    <div class="card">
        <h2 id="formTitle">‚ûï Ajouter un point de vente</h2>
        <input type="text" id="nom" placeholder="Nom de la station">
        <input type="text" id="adresse" placeholder="Adresse / Quartier">
        <input type="tel" id="telephone" placeholder="T√©l√©phone (ex: 70 12 34 56)">
        <div class="coords">
            <input type="number" id="lat" placeholder="Latitude (ex: 12.37)" step="0.000001">
            <input type="number" id="lng" placeholder="Longitude (ex: -1.52)" step="0.000001">
        </div>
        <div class="hint">üí° Google Maps ‚Üí Clic droit sur l'endroit ‚Üí 1√®re ligne = coordonn√©es</div>
        
        <div class="brands-section">
            <h3>üì¶ Marques et formats disponibles</h3>
            <div id="brandsContainer"></div>
        </div>

        <button class="btn-add" id="submitBtn" onclick="ajouterStation()">‚ûï Ajouter la station</button>
        <button class="btn-add" id="cancelBtn" onclick="cancelEdit()" style="background:#7F8C8D;margin-top:0.5rem;display:none;">Annuler</button>
    </div>

    <div class="card">
        <h2>üìã Gestion des stations</h2>
        <div id="listeStations">
            <p style="text-align:center;padding:1rem;color:#999;">Chargement...</p>
        </div>
    </div>
</div>

<script src="firebase-app.js"></script>
<script src="firebase-database.js"></script>

<script>
var firebaseConfig = {
    apiKey: "AIzaSyAPRPagTMM5etUPT7T-rBgKikV2QmVHoAQ",
    authDomain: "gazdispo-5a9b1.firebaseapp.com",
    databaseURL: "https://gazdispo-5a9b1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "gazdispo-5a9b1",
    storageBucket: "gazdispo-5a9b1.firebasestorage.app",
    messagingSenderId: "815895848815",
    appId: "1:815895848815:web:d6fdc94accc1f670ac6a9a"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

var editingStationId = null;

var BRANDS = {
    'sodigaz': { name: 'SODIGAZ', formats: ['3kg', '6kg', '12.5kg', '35kg'] },
    'total': { name: 'TotalEnergies', formats: ['6kg', '12.5kg', '35kg'] },
    'oryx': { name: 'Oryx Energy', formats: ['6kg', '12.5kg', '35kg'] },
    'shell': { name: 'Shell', formats: ['6kg', '12.5kg'] },
    'pegaz': { name: 'P√©gaz', formats: ['6kg', '12.5kg'] },
    'petrofa': { name: 'Petrofa', formats: ['6kg', '12.5kg', '35kg'] },
    'ecogaz': { name: 'Ecogaz', formats: ['6kg', '12.5kg'] }
};

function initBrandsUI() {
    var container = document.getElementById('brandsContainer');
    var html = '';
    
    for (var brandId in BRANDS) {
        var brand = BRANDS[brandId];
        html += '<div class="brand-group">';
        html += '<div class="brand-name">';
        html += '<input type="checkbox" id="brand_' + brandId + '" onchange="toggleBrand(\'' + brandId + '\')">';
        html += '<label for="brand_' + brandId + '">' + brand.name + '</label>';
        html += '</div>';
        html += '<div class="formats" id="formats_' + brandId + '" style="display:none;">';
        
        for (var i = 0; i < brand.formats.length; i++) {
            var format = brand.formats[i];
            html += '<div class="format-option">';
            html += '<input type="checkbox" id="format_' + brandId + '_' + format.replace('.', '_') + '">';
            html += '<label>' + format + '</label>';
            html += '</div>';
        }
        
        html += '</div></div>';
    }
    
    container.innerHTML = html;
}

function toggleBrand(brandId) {
    var checkbox = document.getElementById('brand_' + brandId);
    var formatsDiv = document.getElementById('formats_' + brandId);
    formatsDiv.style.display = checkbox.checked ? 'flex' : 'none';
    
    if (!checkbox.checked) {
        var formats = BRANDS[brandId].formats;
        for (var i = 0; i < formats.length; i++) {
            var formatCheckbox = document.getElementById('format_' + brandId + '_' + formats[i].replace('.', '_'));
            if (formatCheckbox) formatCheckbox.checked = false;
        }
    }
}

function getBrandsData() {
    var brandsData = {};
    
    for (var brandId in BRANDS) {
        var brandCheckbox = document.getElementById('brand_' + brandId);
        if (brandCheckbox && brandCheckbox.checked) {
            brandsData[brandId] = {};
            var formats = BRANDS[brandId].formats;
            
            for (var i = 0; i < formats.length; i++) {
                var format = formats[i];
                var formatCheckbox = document.getElementById('format_' + brandId + '_' + format.replace('.', '_'));
                if (formatCheckbox && formatCheckbox.checked) {
                    brandsData[brandId][format] = 'available';
                }
            }
            
            if (Object.keys(brandsData[brandId]).length === 0) {
                delete brandsData[brandId];
            }
        }
    }
    
    return brandsData;
}

function setBrandsData(brandsData) {
    for (var brandId in BRANDS) {
        var brandCheckbox = document.getElementById('brand_' + brandId);
        var formatsDiv = document.getElementById('formats_' + brandId);
        
        if (brandsData && brandsData[brandId]) {
            brandCheckbox.checked = true;
            formatsDiv.style.display = 'flex';
            
            var formats = BRANDS[brandId].formats;
            for (var i = 0; i < formats.length; i++) {
                var format = formats[i];
                var formatCheckbox = document.getElementById('format_' + brandId + '_' + format.replace('.', '_'));
                if (formatCheckbox) {
                    formatCheckbox.checked = brandsData[brandId][format] !== undefined;
                }
            }
        } else {
            brandCheckbox.checked = false;
            formatsDiv.style.display = 'none';
        }
    }
}

function login() {
    var pwd = document.getElementById('passwordInput').value;
    if (pwd === 'GazBF2026!Secure#') {
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('adminBox').classList.remove('hidden');
        initBrandsUI();
        connecterFirebase();
    } else {
        alert('Mot de passe incorrect !');
    }
}

function connecterFirebase() {
    document.getElementById('status').textContent = 'Connexion Firebase...';
    db.ref('stations').on('value', function(snapshot) {
        document.getElementById('status').textContent = '‚úÖ Firebase connect√© !';
        var data = snapshot.val();
        afficherStations(data);
    }, function(error) {
        document.getElementById('status').textContent = '‚ùå Erreur: ' + error.message;
    });
}

function afficherStations(data) {
    var container = document.getElementById('listeStations');
    if (!data) {
        container.innerHTML = '<p style="text-align:center;padding:1rem;color:#999;">Aucune station. Ajoutez-en une !</p>';
        return;
    }
    var stations = Object.values(data);
    var html = '';
    for (var i = 0; i < stations.length; i++) {
        var s = stations[i];
        html += '<div class="station' + (editingStationId === s.id ? ' edit-mode' : '') + '">';
        html += '<div class="station-name">' + s.name + '</div>';
        html += '<div class="station-address">üìç ' + s.address + '</div>';
        if (s.phone) {
            html += '<div class="station-phone">üìû ' + s.phone + '</div>';
        }
        
        if (s.brands) {
            html += '<div class="station-brands">';
            for (var brandId in s.brands) {
                if (BRANDS[brandId]) {
                    var formats = Object.keys(s.brands[brandId]);
                    if (formats.length > 0) {
                        html += '<span class="brand-badge">' + BRANDS[brandId].name + ': ' + formats.join(', ') + '</span>';
                    }
                }
            }
            html += '</div>';
        }
        
        html += '<div class="station-btns">';
        html += '<button class="btn-edit" onclick="editStation(\'' + s.id + '\')">‚úèÔ∏è Modifier</button>';
        html += '<button class="btn-delete" onclick="supprimerStation(\'' + s.id + '\')">üóëÔ∏è Supprimer</button>';
        html += '</div></div>';
    }
    container.innerHTML = html;
}

function ajouterStation() {
    var nom = document.getElementById('nom').value.trim();
    var adresse = document.getElementById('adresse').value.trim();
    var telephone = document.getElementById('telephone').value.trim();
    var lat = parseFloat(document.getElementById('lat').value);
    var lng = parseFloat(document.getElementById('lng').value);
    var brands = getBrandsData();

    if (!nom || !adresse) {
        alert('Remplissez le nom et l\'adresse !');
        return;
    }
    if (isNaN(lat) || isNaN(lng)) {
        alert('Coordonn√©es invalides !');
        return;
    }
    if (Object.keys(brands).length === 0) {
        alert('S√©lectionnez au moins une marque et un format !');
        return;
    }

    if (editingStationId) {
        var updates = {
            name: nom,
            address: adresse,
            phone: telephone,
            lat: lat,
            lng: lng,
            brands: brands,
            updatedAt: Date.now()
        };
        db.ref('stations/' + editingStationId).update(updates).then(function() {
            afficherToast('‚úÖ Station mise √† jour !');
            resetForm();
        }).catch(function(error) {
            alert('Erreur: ' + error.message);
        });
    } else {
        var id = 'station_' + Date.now();
        var station = {
            id: id,
            name: nom,
            address: adresse,
            phone: telephone,
            lat: lat,
            lng: lng,
            brands: brands,
            updatedAt: Date.now()
        };
        db.ref('stations/' + id).set(station).then(function() {
            afficherToast('‚úÖ Station ajout√©e !');
            resetForm();
        }).catch(function(error) {
            alert('Erreur: ' + error.message);
        });
    }
}

function editStation(id) {
    db.ref('stations/' + id).once('value').then(function(snapshot) {
        var s = snapshot.val();
        document.getElementById('nom').value = s.name;
        document.getElementById('adresse').value = s.address;
        document.getElementById('telephone').value = s.phone || '';
        document.getElementById('lat').value = s.lat;
        document.getElementById('lng').value = s.lng;
        
        setBrandsData(s.brands);
        
        editingStationId = id;
        document.getElementById('formTitle').textContent = '‚úèÔ∏è Modifier la station';
        document.getElementById('submitBtn').textContent = 'üíæ Mettre √† jour';
        document.getElementById('cancelBtn').style.display = 'block';
        
        window.scrollTo(0, 0);
        afficherStations(null);
        db.ref('stations').once('value').then(function(snap) {
            afficherStations(snap.val());
        });
    });
}

function cancelEdit() {
    resetForm();
}

function resetForm() {
    editingStationId = null;
    document.getElementById('nom').value = '';
    document.getElementById('adresse').value = '';
    document.getElementById('telephone').value = '';
    document.getElementById('lat').value = '';
    document.getElementById('lng').value = '';
    
    for (var brandId in BRANDS) {
        var brandCheckbox = document.getElementById('brand_' + brandId);
        if (brandCheckbox) brandCheckbox.checked = false;
        toggleBrand(brandId);
    }
    
    document.getElementById('formTitle').textContent = '‚ûï Ajouter un point de vente';
    document.getElementById('submitBtn').textContent = '‚ûï Ajouter la station';
    document.getElementById('cancelBtn').style.display = 'none';
}

function supprimerStation(id) {
    if (confirm('Supprimer cette station ?')) {
        db.ref('stations/' + id).remove().then(function() {
            afficherToast('‚úÖ Station supprim√©e !');
            if (editingStationId === id) {
                resetForm();
            }
        }).catch(function(e) {
            alert('Erreur: ' + e.message);
        });
    }
}

function afficherToast(msg) {
    var toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 3000);
}
</script>

</body>
</html>
